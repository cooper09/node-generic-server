var mongoose = require('mongoose');
var LogEntry = require('./lib/log_entry');


var entries_temp = [];
var threshold = 10;
var ready = false;

module.exports.setupLogging = function (mongo_url, callback) {
  console.log("logging.setupLogging", mongo_url);
  mongoose.connection.on("open", function(){
    console.log("connected to db");
    ready = true;
    callback();
  });
  mongoose.connect(mongo_url);
}

module.exports.addEntry = function (timestamp, data) {
  if(!ready){
    console.log("logger not ready. please setupLogging()");
    return;
  }
  var e = new LogEntry({timestamp:timestamp, data:data});
  entries_temp.push(e);

  if(entries_temp.length >= threshold){
    console.log("auto saving log entries");
    saveEntries();
  }
}

module.exports.saveEntries = saveEntries= function () {
  if(!ready){
    console.log("logger not ready. please setupLogging()");
    return;
  }
  LogEntry.insertMany(entries_temp).then(function(mongooseDocuments) {
     console.log("saved", mongooseDocuments.length, "entries");
     entries_temp = [];
  }).catch(function(err) {
    console.log("failed to save entries", err);
  });
}